<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zabbix Alert Dashboard</title>
    
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Bootstrap Icons via CDN -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Space Grotesk', 'system-ui', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        zabbix: {
                            disaster: '#E45959',
                            high: '#E97659',
                            average: '#FFA059',
                            warning: '#FFC859',
                            info: '#7499FF',
                            notclass: '#97AAB3',
                        },
                        dark: {
                            900: '#0a0a0f',
                            800: '#12121a',
                            700: '#1a1a24',
                            600: '#22222e',
                            500: '#2a2a38',
                        }
                    }
                }
            }
        }
    </script>
    
    <style>
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1a1a24; }
        ::-webkit-scrollbar-thumb { background: #3a3a4a; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #4a4a5a; }
        
        .gradient-text {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3); }
        
        .severity-pulse { animation: severityPulse 2s infinite; }
        @keyframes severityPulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        
        .toast { transform: translateX(100%); transition: transform 0.3s ease; }
        .toast.show { transform: translateX(0); }
        
        .modal-backdrop { background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(4px); }
        
        .alert-row { transition: background-color 0.2s ease; }
        .alert-row:hover { background-color: rgba(99, 102, 241, 0.1); }
        .alert-row.unread { border-left: 3px solid #6366f1; }
        
        .animate-fade-in { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { 0% { opacity: 0; } 100% { opacity: 1; } }
        
        .animate-slide-in { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { 0% { transform: translateX(100%); opacity: 0; } 100% { transform: translateX(0); opacity: 1; } }
    </style>
</head>
<body class="bg-dark-900 text-gray-100 font-sans min-h-screen">
    <div id="app" class="flex h-screen overflow-hidden">
        
        <!-- Sidebar -->
        <aside class="w-64 bg-dark-800 border-r border-dark-600 flex flex-col">
            <div class="p-6 border-b border-dark-600">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center">
                        <i class="bi bi-shield-exclamation text-white text-xl"></i>
                    </div>
                    <div>
                        <h1 class="font-bold text-lg gradient-text">Zabbix Alerts</h1>
                        <p class="text-xs text-gray-500">Dashboard v1.0</p>
                    </div>
                </div>
            </div>
            
            <nav class="flex-1 p-4 space-y-2">
                <button onclick="showSection('dashboard')" id="nav-dashboard" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-lg bg-dark-700 text-indigo-400 transition-all">
                    <i class="bi bi-grid-1x2-fill"></i>
                    <span>Dashboard</span>
                </button>
                <button onclick="showSection('alerts')" id="nav-alerts" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-dark-700 text-gray-400 hover:text-white transition-all">
                    <i class="bi bi-bell-fill"></i>
                    <span>Alerts</span>
                    <span id="unread-badge" class="ml-auto bg-red-500 text-white text-xs px-2 py-0.5 rounded-full hidden">0</span>
                </button>
                <button onclick="showSection('analytics')" id="nav-analytics" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-dark-700 text-gray-400 hover:text-white transition-all">
                    <i class="bi bi-graph-up"></i>
                    <span>Analytics</span>
                </button>
                <button onclick="showSection('categories')" id="nav-categories" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-dark-700 text-gray-400 hover:text-white transition-all">
                    <i class="bi bi-folder-fill"></i>
                    <span>Categories</span>
                </button>
                <button onclick="showSection('archived')" id="nav-archived" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-dark-700 text-gray-400 hover:text-white transition-all">
                    <i class="bi bi-archive-fill"></i>
                    <span>Archived</span>
                </button>
            </nav>
            
            <div class="p-4 border-t border-dark-600">
                <button onclick="openSettingsModal()" class="w-full flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-dark-700 text-gray-400 hover:text-white transition-all">
                    <i class="bi bi-gear-fill"></i>
                    <span>Settings</span>
                </button>
            </div>
        </aside>
        
        <!-- Main Content -->
        <main class="flex-1 flex flex-col overflow-hidden">
            
            <header class="bg-dark-800 border-b border-dark-600 px-6 py-4">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 id="section-title" class="text-2xl font-bold">Zabbix Problems Dashboard</h2>
                        <p id="section-subtitle" class="text-sm text-gray-500">Overview of your Zabbix alerts</p>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center space-x-2">
                            <span class="text-sm text-gray-400">Auto Refresh</span>
                            <button id="auto-refresh-toggle" onclick="toggleAutoRefresh()" class="w-12 h-6 rounded-full bg-dark-600 relative transition-colors">
                                <span class="absolute left-1 top-1 w-4 h-4 rounded-full bg-gray-400 transition-transform"></span>
                            </button>
                        </div>
                        
                        <button onclick="fetchAlerts()" id="refresh-btn" class="flex items-center space-x-2 px-4 py-2 bg-indigo-600 hover:bg-indigo-700 rounded-lg transition-colors">
                            <i class="bi bi-arrow-clockwise" id="refresh-icon"></i>
                            <span>Refresh</span>
                        </button>
                        
                        <div id="connection-status" class="flex items-center space-x-2 px-3 py-2 rounded-lg bg-dark-700">
                            <span class="w-2 h-2 rounded-full bg-gray-500"></span>
                            <span class="text-sm text-gray-400">Not Connected</span>
                        </div>
                    </div>
                </div>
            </header>
            
            <div class="flex-1 overflow-auto p-6">
                
                <!-- Dashboard Section -->
                <section id="section-dashboard" class="section-content">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div class="bg-dark-800 rounded-2xl p-6 border border-dark-600 card-hover">
                            <div class="flex items-center justify-between mb-4">
                                <div class="w-12 h-12 rounded-xl bg-red-500/20 flex items-center justify-center">
                                    <i class="bi bi-exclamation-triangle-fill text-red-500 text-xl"></i>
                                </div>
                                <span class="text-xs text-gray-500 uppercase tracking-wide">Active</span>
                            </div>
                            <p id="stat-active" class="text-4xl font-bold text-white mb-1">0</p>
                            <p class="text-sm text-gray-500">Active Problems</p>
                        </div>
                        
                        <div class="bg-dark-800 rounded-2xl p-6 border border-dark-600 card-hover">
                            <div class="flex items-center justify-between mb-4">
                                <div class="w-12 h-12 rounded-xl bg-green-500/20 flex items-center justify-center">
                                    <i class="bi bi-check-circle-fill text-green-500 text-xl"></i>
                                </div>
                                <span class="text-xs text-gray-500 uppercase tracking-wide">Resolved</span>
                            </div>
                            <p id="stat-resolved" class="text-4xl font-bold text-white mb-1">0</p>
                            <p class="text-sm text-gray-500">Resolved Today</p>
                        </div>
                        
                        <div class="bg-dark-800 rounded-2xl p-6 border border-dark-600 card-hover">
                            <div class="flex items-center justify-between mb-4">
                                <div class="w-12 h-12 rounded-xl bg-indigo-500/20 flex items-center justify-center">
                                    <i class="bi bi-envelope-fill text-indigo-500 text-xl"></i>
                                </div>
                                <span class="text-xs text-gray-500 uppercase tracking-wide">Unread</span>
                            </div>
                            <p id="stat-unread" class="text-4xl font-bold text-white mb-1">0</p>
                            <p class="text-sm text-gray-500">Unread Alerts</p>
                        </div>
                        
                        <div class="bg-dark-800 rounded-2xl p-6 border border-dark-600 card-hover">
                            <div class="flex items-center justify-between mb-4">
                                <div class="w-12 h-12 rounded-xl bg-purple-500/20 flex items-center justify-center">
                                    <i class="bi bi-clock-history text-purple-500 text-xl"></i>
                                </div>
                                <span class="text-xs text-gray-500 uppercase tracking-wide">24h</span>
                            </div>
                            <p id="stat-24h" class="text-4xl font-bold text-white mb-1">0</p>
                            <p class="text-sm text-gray-500">Last 24 Hours</p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-dark-800 rounded-2xl p-6 border border-dark-600">
                            <h3 class="text-lg font-semibold mb-4">Alerts by Severity</h3>
                            <div id="severity-breakdown" class="space-y-4"></div>
                        </div>
                        
                        <div class="bg-dark-800 rounded-2xl p-6 border border-dark-600">
                            <h3 class="text-lg font-semibold mb-4">Recent Activity</h3>
                            <div id="recent-alerts" class="space-y-3 max-h-80 overflow-y-auto"></div>
                        </div>
                    </div>
                </section>
                
                <!-- Alerts Section -->
                <section id="section-alerts" class="section-content hidden">
                    <div class="bg-dark-800 rounded-2xl p-4 border border-dark-600 mb-6">
                        <div class="flex flex-wrap items-center gap-4">
                            <div class="flex-1 min-w-64">
                                <div class="relative">
                                    <i class="bi bi-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-500"></i>
                                    <input type="text" id="search-input" placeholder="Search hosts or triggers..." 
                                           class="w-full pl-10 pr-4 py-2 bg-dark-700 border border-dark-600 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-indigo-500 transition-colors">
                                </div>
                            </div>
                            
                            <select id="filter-severity" class="px-4 py-2 bg-dark-700 border border-dark-600 rounded-lg text-white focus:outline-none focus:border-indigo-500">
                                <option value="">All Severities</option>
                                <option value="5">Disaster</option>
                                <option value="4">High</option>
                                <option value="3">Average</option>
                                <option value="2">Warning</option>
                                <option value="1">Information</option>
                                <option value="0">Not classified</option>
                            </select>
                            
                            <select id="filter-status" class="px-4 py-2 bg-dark-700 border border-dark-600 rounded-lg text-white focus:outline-none focus:border-indigo-500">
                                <option value="">All Status</option>
                                <option value="0">Active</option>
                                <option value="1">Resolved</option>
                            </select>
                            
                            <select id="filter-category" class="px-4 py-2 bg-dark-700 border border-dark-600 rounded-lg text-white focus:outline-none focus:border-indigo-500">
                                <option value="">All Categories</option>
                            </select>
                            
                            <button onclick="applyFilters()" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 rounded-lg transition-colors">
                                <i class="bi bi-funnel"></i> Apply
                            </button>
                            
                            <button onclick="clearFilters()" class="px-4 py-2 bg-dark-700 hover:bg-dark-600 rounded-lg transition-colors">
                                <i class="bi bi-x-circle"></i> Clear
                            </button>
                        </div>
                    </div>
                    
                    <div id="bulk-actions" class="hidden bg-indigo-900/30 rounded-xl p-3 border border-indigo-500/30 mb-4 animate-fade-in">
                        <div class="flex items-center justify-between">
                            <span class="text-sm"><span id="selected-count">0</span> alerts selected</span>
                            <div class="flex items-center space-x-2">
                                <button onclick="bulkAction('mark_read')" class="px-3 py-1.5 bg-dark-700 hover:bg-dark-600 rounded-lg text-sm transition-colors">
                                    <i class="bi bi-envelope-open"></i> Mark Read
                                </button>
                                <button onclick="bulkAction('archive')" class="px-3 py-1.5 bg-dark-700 hover:bg-dark-600 rounded-lg text-sm transition-colors">
                                    <i class="bi bi-archive"></i> Archive
                                </button>
                                <button onclick="openBulkCategoryModal()" class="px-3 py-1.5 bg-dark-700 hover:bg-dark-600 rounded-lg text-sm transition-colors">
                                    <i class="bi bi-folder"></i> Set Category
                                </button>
                                <button onclick="bulkAction('delete')" class="px-3 py-1.5 bg-red-600 hover:bg-red-700 rounded-lg text-sm transition-colors">
                                    <i class="bi bi-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-dark-800 rounded-2xl border border-dark-600 overflow-hidden">
                        <table class="w-full">
                            <thead class="bg-dark-700">
                                <tr>
                                    <th class="px-4 py-3 text-left">
                                        <input type="checkbox" id="select-all" onchange="toggleSelectAll()" class="rounded bg-dark-600 border-dark-500">
                                    </th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-400">Severity</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-400">Host</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-400">Problem</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-400">Category</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-400">Time</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-400">Status</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-400">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="alerts-table-body"></tbody>
                        </table>
                        
                        <div id="alerts-empty" class="hidden py-16 text-center">
                            <i class="bi bi-inbox text-6xl text-gray-600 mb-4"></i>
                            <p class="text-gray-400">No alerts found</p>
                            <p class="text-sm text-gray-500 mt-2">Configure your Zabbix settings and fetch alerts</p>
                        </div>
                    </div>
                    
                    <div id="pagination" class="flex items-center justify-between mt-4">
                        <span id="pagination-info" class="text-sm text-gray-500">Showing 0 of 0 alerts</span>
                        <div class="flex items-center space-x-2">
                            <button id="prev-page" onclick="changePage(-1)" class="px-3 py-1 bg-dark-700 hover:bg-dark-600 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed">
                                <i class="bi bi-chevron-left"></i>
                            </button>
                            <span id="current-page" class="px-3 py-1 bg-dark-800 rounded-lg">1</span>
                            <button id="next-page" onclick="changePage(1)" class="px-3 py-1 bg-dark-700 hover:bg-dark-600 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed">
                                <i class="bi bi-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </section>
                
                <!-- Categories Section -->
                <section id="section-categories" class="section-content hidden">
                    <div class="flex justify-between items-center mb-6">
                        <p class="text-gray-400">Organize your alerts with custom categories</p>
                        <button onclick="openCategoryModal()" class="flex items-center space-x-2 px-4 py-2 bg-indigo-600 hover:bg-indigo-700 rounded-lg transition-colors">
                            <i class="bi bi-plus-lg"></i>
                            <span>New Category</span>
                        </button>
                    </div>
                    
                    <div id="categories-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                </section>
                
                <!-- Analytics Section -->
                <section id="section-analytics" class="section-content hidden">
                    <!-- Summary Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                        <div class="bg-dark-800 rounded-xl p-4 border border-dark-600">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-xs text-gray-500 uppercase">Total Hosts</p>
                                    <p id="analytics-total-hosts" class="text-2xl font-bold">0</p>
                                </div>
                                <div class="w-10 h-10 rounded-lg bg-indigo-500/20 flex items-center justify-center">
                                    <i class="bi bi-hdd-network text-indigo-400"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-dark-800 rounded-xl p-4 border border-dark-600">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-xs text-gray-500 uppercase">Critical Hosts</p>
                                    <p id="analytics-critical-hosts" class="text-2xl font-bold text-red-400">0</p>
                                </div>
                                <div class="w-10 h-10 rounded-lg bg-red-500/20 flex items-center justify-center">
                                    <i class="bi bi-exclamation-octagon text-red-400"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-dark-800 rounded-xl p-4 border border-dark-600">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-xs text-gray-500 uppercase">Avg Resolution</p>
                                    <p id="analytics-mttr" class="text-2xl font-bold text-green-400">0m</p>
                                </div>
                                <div class="w-10 h-10 rounded-lg bg-green-500/20 flex items-center justify-center">
                                    <i class="bi bi-clock-history text-green-400"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-dark-800 rounded-xl p-4 border border-dark-600">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-xs text-gray-500 uppercase">Uncategorized</p>
                                    <p id="analytics-uncategorized" class="text-2xl font-bold text-yellow-400">0</p>
                                </div>
                                <div class="w-10 h-10 rounded-lg bg-yellow-500/20 flex items-center justify-center">
                                    <i class="bi bi-question-circle text-yellow-400"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <!-- Top Hosts -->
                        <div class="bg-dark-800 rounded-2xl border border-dark-600 overflow-hidden">
                            <div class="p-4 border-b border-dark-600 flex items-center justify-between">
                                <h3 class="font-semibold flex items-center"><i class="bi bi-trophy text-yellow-400 mr-2"></i>Top Hosts by Alerts</h3>
                                <span class="text-xs text-gray-500">Click to filter</span>
                            </div>
                            <div id="top-hosts-list" class="max-h-96 overflow-y-auto">
                                <div class="p-8 text-center text-gray-500">Loading...</div>
                            </div>
                        </div>
                        
                        <!-- Alert Types -->
                        <div class="bg-dark-800 rounded-2xl border border-dark-600 overflow-hidden">
                            <div class="p-4 border-b border-dark-600">
                                <h3 class="font-semibold flex items-center"><i class="bi bi-lightning text-purple-400 mr-2"></i>Common Alert Types</h3>
                            </div>
                            <div id="alert-types-list" class="max-h-96 overflow-y-auto">
                                <div class="p-8 text-center text-gray-500">Loading...</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                        <!-- Severity Distribution -->
                        <div class="bg-dark-800 rounded-2xl p-6 border border-dark-600">
                            <h3 class="font-semibold mb-4 flex items-center"><i class="bi bi-pie-chart text-blue-400 mr-2"></i>Severity Distribution</h3>
                            <div id="severity-chart" class="space-y-3"></div>
                        </div>
                        
                        <!-- Host Health -->
                        <div class="bg-dark-800 rounded-2xl p-6 border border-dark-600">
                            <h3 class="font-semibold mb-4 flex items-center"><i class="bi bi-heart-pulse text-red-400 mr-2"></i>Host Health Overview</h3>
                            <div id="host-health-chart" class="space-y-3"></div>
                        </div>
                        
                        <!-- Hourly Distribution -->
                        <div class="bg-dark-800 rounded-2xl p-6 border border-dark-600">
                            <h3 class="font-semibold mb-4 flex items-center"><i class="bi bi-clock text-cyan-400 mr-2"></i>Alerts by Hour</h3>
                            <div id="hourly-chart" class="h-40 flex items-end justify-between gap-1"></div>
                            <div class="flex justify-between text-xs text-gray-500 mt-2">
                                <span>00:00</span>
                                <span>12:00</span>
                                <span>23:00</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <!-- Daily Trend -->
                        <div class="bg-dark-800 rounded-2xl p-6 border border-dark-600">
                            <h3 class="font-semibold mb-4 flex items-center"><i class="bi bi-graph-up-arrow text-green-400 mr-2"></i>30-Day Trend</h3>
                            <div id="daily-trend-chart" class="h-48 flex items-end gap-1"></div>
                        </div>
                        
                        <!-- Repeat Offenders -->
                        <div class="bg-dark-800 rounded-2xl border border-dark-600 overflow-hidden">
                            <div class="p-4 border-b border-dark-600">
                                <h3 class="font-semibold flex items-center"><i class="bi bi-arrow-repeat text-orange-400 mr-2"></i>Recurring Issues</h3>
                                <p class="text-xs text-gray-500 mt-1">Same host + trigger combinations</p>
                            </div>
                            <div id="repeat-offenders-list" class="max-h-64 overflow-y-auto">
                                <div class="p-8 text-center text-gray-500">Loading...</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Category Breakdown -->
                    <div class="bg-dark-800 rounded-2xl p-6 border border-dark-600">
                        <h3 class="font-semibold mb-4 flex items-center"><i class="bi bi-folder2-open text-indigo-400 mr-2"></i>Category Breakdown</h3>
                        <div id="category-breakdown" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4"></div>
                    </div>
                </section>
                
                <!-- Archived Section -->
                <section id="section-archived" class="section-content hidden">
                    <div class="bg-dark-800 rounded-2xl border border-dark-600 overflow-hidden">
                        <table class="w-full">
                            <thead class="bg-dark-700">
                                <tr>
                                    <th class="px-4 py-3 text-left">
                                        <input type="checkbox" id="select-all-archived" onchange="toggleSelectAllArchived()" class="rounded bg-dark-600 border-dark-500">
                                    </th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-400">Severity</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-400">Host</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-400">Problem</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-400">Archived Date</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-400">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="archived-table-body"></tbody>
                        </table>
                        
                        <div id="archived-empty" class="hidden py-16 text-center">
                            <i class="bi bi-archive text-6xl text-gray-600 mb-4"></i>
                            <p class="text-gray-400">No archived alerts</p>
                        </div>
                    </div>
                </section>
            </div>
        </main>
    </div>
    
    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 z-50 hidden">
        <div class="modal-backdrop absolute inset-0" onclick="closeSettingsModal()"></div>
        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-lg animate-fade-in">
            <div class="bg-dark-800 rounded-2xl border border-dark-600 shadow-2xl max-h-[90vh] overflow-y-auto">
                <div class="flex items-center justify-between p-6 border-b border-dark-600 sticky top-0 bg-dark-800">
                    <h3 class="text-xl font-bold">Settings</h3>
                    <button onclick="closeSettingsModal()" class="text-gray-400 hover:text-white">
                        <i class="bi bi-x-lg text-xl"></i>
                    </button>
                </div>
                <div class="p-6 space-y-6">
                    <!-- Zabbix URL -->
                    <div>
                        <label class="block text-sm font-medium text-gray-400 mb-2">Zabbix URL</label>
                        <input type="url" id="setting-zabbix-url" placeholder="https://zabbix.example.com" 
                               class="w-full px-4 py-3 bg-dark-700 border border-dark-600 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-indigo-500">
                        <p class="text-xs text-gray-500 mt-1">The base URL of your Zabbix server</p>
                    </div>
                    
                    <!-- Auth Method Tabs -->
                    <div class="bg-dark-700 rounded-xl p-1 flex">
                        <button onclick="showAuthTab('apikey')" id="auth-tab-apikey" class="auth-tab flex-1 px-4 py-2 rounded-lg bg-dark-600 text-white text-sm font-medium transition-colors">
                            <i class="bi bi-key mr-2"></i>API Key
                        </button>
                        <button onclick="showAuthTab('credentials')" id="auth-tab-credentials" class="auth-tab flex-1 px-4 py-2 rounded-lg text-gray-400 text-sm font-medium transition-colors hover:text-white">
                            <i class="bi bi-person-lock mr-2"></i>Username/Password
                        </button>
                    </div>
                    
                    <!-- API Key Section -->
                    <div id="auth-section-apikey" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-2">API Key</label>
                            <div class="relative">
                                <input type="password" id="setting-api-key" placeholder="Enter your Zabbix API key" 
                                       class="w-full px-4 py-3 bg-dark-700 border border-dark-600 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-indigo-500 pr-12">
                                <button onclick="toggleApiKeyVisibility()" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-white">
                                    <i class="bi bi-eye" id="api-key-toggle-icon"></i>
                                </button>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">Generate an API token in Zabbix: Administration â†’ API tokens</p>
                        </div>
                        <div class="bg-indigo-900/20 border border-indigo-500/30 rounded-lg p-3">
                            <p class="text-xs text-indigo-300"><i class="bi bi-info-circle mr-1"></i> API key is the recommended method for Zabbix 5.4+</p>
                        </div>
                    </div>
                    
                    <!-- Username/Password Section -->
                    <div id="auth-section-credentials" class="space-y-4 hidden">
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-2">Username</label>
                            <input type="text" id="setting-username" placeholder="Enter your Zabbix username" 
                                   class="w-full px-4 py-3 bg-dark-700 border border-dark-600 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-indigo-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-2">Password</label>
                            <div class="relative">
                                <input type="password" id="setting-password" placeholder="Enter your Zabbix password" 
                                       class="w-full px-4 py-3 bg-dark-700 border border-dark-600 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-indigo-500 pr-12">
                                <button onclick="togglePasswordVisibility()" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-white">
                                    <i class="bi bi-eye" id="password-toggle-icon"></i>
                                </button>
                            </div>
                        </div>
                        <div class="bg-yellow-900/20 border border-yellow-500/30 rounded-lg p-3">
                            <p class="text-xs text-yellow-300"><i class="bi bi-exclamation-triangle mr-1"></i> Username/password auth works with all Zabbix versions. Used as fallback if API key fails.</p>
                        </div>
                    </div>
                    
                    <hr class="border-dark-600">
                    
                    <!-- Refresh Interval -->
                    <div>
                        <label class="block text-sm font-medium text-gray-400 mb-2">Auto Refresh Interval (seconds)</label>
                        <input type="number" id="setting-refresh-interval" min="10" max="300" value="30" 
                               class="w-full px-4 py-3 bg-dark-700 border border-dark-600 rounded-lg text-white focus:outline-none focus:border-indigo-500">
                    </div>
                    
                    <!-- Current Auth Status -->
                    <div id="auth-status-box" class="bg-dark-700 rounded-lg p-4">
                        <h4 class="text-sm font-medium text-gray-400 mb-2">Current Configuration</h4>
                        <div id="auth-status-content" class="text-sm space-y-1">
                            <p class="text-gray-500">Not configured</p>
                        </div>
                    </div>
                </div>
                <div class="flex justify-end space-x-3 p-6 border-t border-dark-600 sticky bottom-0 bg-dark-800">
                    <button onclick="closeSettingsModal()" class="px-4 py-2 bg-dark-700 hover:bg-dark-600 rounded-lg transition-colors">Cancel</button>
                    <button onclick="testConnection()" class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg transition-colors">
                        <i class="bi bi-plug mr-2"></i>Test Connection
                    </button>
                    <button onclick="saveSettings()" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 rounded-lg transition-colors">Save Settings</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Alert Detail Modal -->
    <div id="alert-modal" class="fixed inset-0 z-50 hidden">
        <div class="modal-backdrop absolute inset-0" onclick="closeAlertModal()"></div>
        <div class="absolute top-0 right-0 w-full max-w-xl h-full animate-slide-in">
            <div class="bg-dark-800 h-full border-l border-dark-600 shadow-2xl flex flex-col">
                <div class="flex items-center justify-between p-6 border-b border-dark-600">
                    <h3 class="text-xl font-bold">Alert Details</h3>
                    <button onclick="closeAlertModal()" class="text-gray-400 hover:text-white">
                        <i class="bi bi-x-lg text-xl"></i>
                    </button>
                </div>
                <div class="flex-1 overflow-y-auto p-6">
                    <div id="alert-detail-content"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Category Modal -->
    <div id="category-modal" class="fixed inset-0 z-50 hidden">
        <div class="modal-backdrop absolute inset-0" onclick="closeCategoryModal()"></div>
        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-md animate-fade-in">
            <div class="bg-dark-800 rounded-2xl border border-dark-600 shadow-2xl">
                <div class="flex items-center justify-between p-6 border-b border-dark-600">
                    <h3 id="category-modal-title" class="text-xl font-bold">New Category</h3>
                    <button onclick="closeCategoryModal()" class="text-gray-400 hover:text-white">
                        <i class="bi bi-x-lg text-xl"></i>
                    </button>
                </div>
                <div class="p-6 space-y-4">
                    <input type="hidden" id="category-edit-id">
                    <div>
                        <label class="block text-sm font-medium text-gray-400 mb-2">Name</label>
                        <input type="text" id="category-name" placeholder="Category name" 
                               class="w-full px-4 py-3 bg-dark-700 border border-dark-600 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-400 mb-2">Color</label>
                        <div class="flex items-center space-x-3">
                            <input type="color" id="category-color" value="#6366f1" class="w-12 h-12 rounded-lg bg-transparent cursor-pointer">
                            <input type="text" id="category-color-text" value="#6366f1" 
                                   class="flex-1 px-4 py-3 bg-dark-700 border border-dark-600 rounded-lg text-white font-mono focus:outline-none focus:border-indigo-500">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-400 mb-2">Description</label>
                        <textarea id="category-description" rows="3" placeholder="Optional description" 
                                  class="w-full px-4 py-3 bg-dark-700 border border-dark-600 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-indigo-500 resize-none"></textarea>
                    </div>
                </div>
                <div class="flex justify-end space-x-3 p-6 border-t border-dark-600">
                    <button onclick="closeCategoryModal()" class="px-4 py-2 bg-dark-700 hover:bg-dark-600 rounded-lg transition-colors">Cancel</button>
                    <button onclick="saveCategory()" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 rounded-lg transition-colors">Save Category</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Toast Container -->
    <div id="toast-container" class="fixed bottom-4 right-4 z-50 space-y-2"></div>
    
    <script>
        let state = {
            currentSection: 'dashboard',
            alerts: [],
            categories: [],
            settings: {},
            selectedAlerts: new Set(),
            currentPage: 1,
            totalPages: 1,
            autoRefreshInterval: null,
            isAutoRefresh: false,
            filters: { search: '', severity: '', status: '', category_id: '' }
        };
        
        document.addEventListener('DOMContentLoaded', async () => {
            await loadSettings();
            await loadCategories();
            await loadStats();
            await loadAlerts();
            
            document.getElementById('category-color').addEventListener('input', (e) => {
                document.getElementById('category-color-text').value = e.target.value;
            });
            document.getElementById('category-color-text').addEventListener('input', (e) => {
                document.getElementById('category-color').value = e.target.value;
            });
            
            let searchTimeout;
            document.getElementById('search-input').addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    state.filters.search = e.target.value;
                    loadAlerts();
                }, 300);
            });
        });
        
        function showSection(section) {
            state.currentSection = section;
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('bg-dark-700', 'text-indigo-400');
                item.classList.add('hover:bg-dark-700', 'text-gray-400', 'hover:text-white');
            });
            const activeNav = document.getElementById(`nav-${section}`);
            activeNav.classList.add('bg-dark-700', 'text-indigo-400');
            activeNav.classList.remove('hover:bg-dark-700', 'text-gray-400', 'hover:text-white');
            
            document.querySelectorAll('.section-content').forEach(s => s.classList.add('hidden'));
            document.getElementById(`section-${section}`).classList.remove('hidden');
            
            const titles = {
                dashboard: ['Dashboard', 'Overview of your Zabbix alerts'],
                alerts: ['Alerts', 'Manage and categorize your alerts'],
                analytics: ['Analytics', 'Insights and trends from your alert data'],
                categories: ['Categories', 'Organize your alerts'],
                archived: ['Archived', 'View archived alerts']
            };
            document.getElementById('section-title').textContent = titles[section][0];
            document.getElementById('section-subtitle').textContent = titles[section][1];
            
            if (section === 'archived') loadArchivedAlerts();
            if (section === 'categories') loadCategories();
            if (section === 'analytics') loadAnalytics();
        }
        
        async function loadSettings() {
            try {
                const res = await fetch('/api/settings');
                state.settings = await res.json();
                document.getElementById('setting-zabbix-url').value = state.settings.zabbix_url || '';
                document.getElementById('setting-refresh-interval').value = state.settings.refresh_interval || 30;
                document.getElementById('setting-username').value = state.settings.username || '';
                updateConnectionStatus();
                updateAuthStatusBox();
                if (state.settings.auto_refresh) toggleAutoRefresh();
            } catch (e) { showToast('Failed to load settings', 'error'); }
        }
        
        function updateAuthStatusBox() {
            const content = document.getElementById('auth-status-content');
            let html = '';
            
            if (state.settings.api_key_masked) {
                html += `<p class="text-green-400"><i class="bi bi-check-circle mr-1"></i> API Key: ${state.settings.api_key_masked}</p>`;
            }
            if (state.settings.username) {
                html += `<p class="text-green-400"><i class="bi bi-check-circle mr-1"></i> Username: ${state.settings.username}</p>`;
                if (state.settings.password_masked) {
                    html += `<p class="text-green-400"><i class="bi bi-check-circle mr-1"></i> Password: ${state.settings.password_masked}</p>`;
                }
            }
            if (!html) {
                html = '<p class="text-gray-500">No authentication configured</p>';
            }
            content.innerHTML = html;
        }
        
        function showAuthTab(tab) {
            document.querySelectorAll('.auth-tab').forEach(t => {
                t.classList.remove('bg-dark-600', 'text-white');
                t.classList.add('text-gray-400');
            });
            document.getElementById(`auth-tab-${tab}`).classList.add('bg-dark-600', 'text-white');
            document.getElementById(`auth-tab-${tab}`).classList.remove('text-gray-400');
            
            document.getElementById('auth-section-apikey').classList.toggle('hidden', tab !== 'apikey');
            document.getElementById('auth-section-credentials').classList.toggle('hidden', tab !== 'credentials');
        }
        
        function updateConnectionStatus() {
            const status = document.getElementById('connection-status');
            if (state.settings.zabbix_url && state.settings.api_key_masked) {
                status.innerHTML = `<span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span><span class="text-sm text-green-400">Connected</span>`;
            } else {
                status.innerHTML = `<span class="w-2 h-2 rounded-full bg-gray-500"></span><span class="text-sm text-gray-400">Not Connected</span>`;
            }
        }
        
        function openSettingsModal() { document.getElementById('settings-modal').classList.remove('hidden'); }
        function closeSettingsModal() { document.getElementById('settings-modal').classList.add('hidden'); }
        
        async function saveSettings() {
            const url = document.getElementById('setting-zabbix-url').value;
            const apiKey = document.getElementById('setting-api-key').value;
            const username = document.getElementById('setting-username').value;
            const password = document.getElementById('setting-password').value;
            const interval = document.getElementById('setting-refresh-interval').value;
            
            try {
                const res = await fetch('/api/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        zabbix_url: url, 
                        api_key: apiKey || undefined, 
                        username: username,
                        password: password || undefined,
                        refresh_interval: parseInt(interval), 
                        auto_refresh: state.isAutoRefresh 
                    })
                });
                const data = await res.json();
                if (data.status === 'success') {
                    showToast('Settings saved successfully', 'success');
                    await loadSettings();
                    closeSettingsModal();
                } else { showToast(data.message || 'Failed to save settings', 'error'); }
            } catch (e) { showToast('Failed to save settings', 'error'); }
        }
        
        async function testConnection() {
            showToast('Testing connection...', 'info');
            
            // Save settings first
            const url = document.getElementById('setting-zabbix-url').value;
            const apiKey = document.getElementById('setting-api-key').value;
            const username = document.getElementById('setting-username').value;
            const password = document.getElementById('setting-password').value;
            
            if (!url) {
                showToast('Please enter a Zabbix URL', 'error');
                return;
            }
            
            if (!apiKey && (!username || !password)) {
                showToast('Please enter either an API key or username/password', 'error');
                return;
            }
            
            try {
                // Save first
                await fetch('/api/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        zabbix_url: url, 
                        api_key: apiKey || undefined, 
                        username: username,
                        password: password || undefined
                    })
                });
                
                // Then test
                const res = await fetch('/api/fetch-alerts', { method: 'POST' });
                const data = await res.json();
                
                if (data.status === 'success') {
                    const authMethod = data.auth_method === 'credentials' ? 'username/password' : 'API key';
                    showToast(`Connection successful! Authenticated using ${authMethod}`, 'success');
                    await loadSettings();
                } else {
                    showToast(data.message || 'Connection failed', 'error');
                }
            } catch (e) {
                showToast('Connection test failed', 'error');
            }
        }
        
        function togglePasswordVisibility() {
            const input = document.getElementById('setting-password');
            const icon = document.getElementById('password-toggle-icon');
            if (input.type === 'password') { input.type = 'text'; icon.className = 'bi bi-eye-slash'; }
            else { input.type = 'password'; icon.className = 'bi bi-eye'; }
        }
        
        function toggleApiKeyVisibility() {
            const input = document.getElementById('setting-api-key');
            const icon = document.getElementById('api-key-toggle-icon');
            if (input.type === 'password') { input.type = 'text'; icon.className = 'bi bi-eye-slash'; }
            else { input.type = 'password'; icon.className = 'bi bi-eye'; }
        }
        
        function toggleAutoRefresh() {
            state.isAutoRefresh = !state.isAutoRefresh;
            const toggle = document.getElementById('auto-refresh-toggle');
            const span = toggle.querySelector('span');
            
            if (state.isAutoRefresh) {
                toggle.classList.add('bg-indigo-600'); toggle.classList.remove('bg-dark-600');
                span.classList.add('translate-x-6', 'bg-white'); span.classList.remove('bg-gray-400');
                const interval = (state.settings.refresh_interval || 30) * 1000;
                state.autoRefreshInterval = setInterval(() => fetchAlerts(), interval);
                showToast(`Auto refresh enabled (${state.settings.refresh_interval || 30}s)`, 'success');
            } else {
                toggle.classList.remove('bg-indigo-600'); toggle.classList.add('bg-dark-600');
                span.classList.remove('translate-x-6', 'bg-white'); span.classList.add('bg-gray-400');
                if (state.autoRefreshInterval) { clearInterval(state.autoRefreshInterval); state.autoRefreshInterval = null; }
                showToast('Auto refresh disabled', 'info');
            }
        }
        
        async function fetchAlerts() {
            const btn = document.getElementById('refresh-btn');
            const icon = document.getElementById('refresh-icon');
            btn.disabled = true; icon.classList.add('animate-spin');
            
            try {
                const res = await fetch('/api/fetch-alerts', { method: 'POST' });
                const data = await res.json();
                if (data.status === 'success') {
                    showToast(data.message, 'success');
                    await loadStats(); await loadAlerts();
                } else { 
                    // Show detailed error modal for configuration issues
                    if (data.message && (data.message.includes('Settings') || data.message.includes('API') || data.message.includes('authorized') || data.message.includes('URL'))) {
                        showErrorModal(data.message);
                    } else {
                        showToast(data.message || 'Failed to fetch alerts', 'error'); 
                    }
                }
            } catch (e) { showToast('Failed to fetch alerts from Zabbix', 'error'); }
            finally { btn.disabled = false; icon.classList.remove('animate-spin'); }
        }
        
        function showErrorModal(message) {
            const modal = document.createElement('div');
            modal.id = 'error-modal';
            modal.className = 'fixed inset-0 z-50 flex items-center justify-center';
            modal.innerHTML = `
                <div class="modal-backdrop absolute inset-0" onclick="this.parentElement.remove()"></div>
                <div class="relative bg-dark-800 rounded-2xl border border-red-500/50 shadow-2xl max-w-lg w-full mx-4 animate-fade-in">
                    <div class="p-6">
                        <div class="flex items-center space-x-3 mb-4">
                            <div class="w-12 h-12 rounded-full bg-red-500/20 flex items-center justify-center">
                                <i class="bi bi-exclamation-triangle-fill text-red-500 text-2xl"></i>
                            </div>
                            <h3 class="text-xl font-bold text-red-400">Connection Error</h3>
                        </div>
                        <p class="text-gray-300 mb-6">${escapeHtml(message)}</p>
                        <div class="bg-dark-700 rounded-xl p-4 mb-6">
                            <h4 class="font-medium mb-2">Troubleshooting Steps:</h4>
                            <ul class="text-sm text-gray-400 space-y-2">
                                <li class="flex items-start space-x-2">
                                    <i class="bi bi-check-circle text-indigo-400 mt-0.5"></i>
                                    <span>Verify your Zabbix URL is correct (e.g., https://zabbix.example.com)</span>
                                </li>
                                <li class="flex items-start space-x-2">
                                    <i class="bi bi-check-circle text-indigo-400 mt-0.5"></i>
                                    <span>Check your API token has read permissions for Problems, Triggers, and Hosts</span>
                                </li>
                                <li class="flex items-start space-x-2">
                                    <i class="bi bi-check-circle text-indigo-400 mt-0.5"></i>
                                    <span>Ensure the API token hasn't expired in Zabbix</span>
                                </li>
                                <li class="flex items-start space-x-2">
                                    <i class="bi bi-check-circle text-indigo-400 mt-0.5"></i>
                                    <span>Confirm network connectivity to the Zabbix server</span>
                                </li>
                            </ul>
                        </div>
                        <div class="flex space-x-3">
                            <button onclick="this.closest('#error-modal').remove()" class="flex-1 px-4 py-2 bg-dark-700 hover:bg-dark-600 rounded-lg transition-colors">
                                Close
                            </button>
                            <button onclick="this.closest('#error-modal').remove(); openSettingsModal();" class="flex-1 px-4 py-2 bg-indigo-600 hover:bg-indigo-700 rounded-lg transition-colors">
                                <i class="bi bi-gear mr-2"></i>Open Settings
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        async function loadStats() {
            try {
                const res = await fetch('/api/stats');
                const stats = await res.json();
                document.getElementById('stat-active').textContent = stats.active_alerts || 0;
                document.getElementById('stat-resolved').textContent = stats.resolved_alerts || 0;
                document.getElementById('stat-unread').textContent = stats.unread || 0;
                document.getElementById('stat-24h').textContent = stats.recent_24h || 0;
                
                const badge = document.getElementById('unread-badge');
                if (stats.unread > 0) { badge.textContent = stats.unread; badge.classList.remove('hidden'); }
                else { badge.classList.add('hidden'); }
                
                renderSeverityBreakdown(stats.by_severity || []);
            } catch (e) { console.error('Failed to load stats:', e); }
        }
        
        function renderSeverityBreakdown(severities) {
            const container = document.getElementById('severity-breakdown');
            const total = severities.reduce((sum, s) => sum + s.count, 0) || 1;
            const severityColors = {
                5: { name: 'Disaster', bg: 'bg-red-500' }, 4: { name: 'High', bg: 'bg-orange-500' },
                3: { name: 'Average', bg: 'bg-amber-500' }, 2: { name: 'Warning', bg: 'bg-yellow-500' },
                1: { name: 'Information', bg: 'bg-blue-500' }, 0: { name: 'Not classified', bg: 'bg-gray-500' }
            };
            container.innerHTML = severities.map(s => {
                const info = severityColors[s.severity] || severityColors[0];
                const percent = Math.round((s.count / total) * 100);
                return `<div class="flex items-center space-x-4"><span class="w-24 text-sm text-gray-400">${info.name}</span><div class="flex-1 h-3 bg-dark-600 rounded-full overflow-hidden"><div class="${info.bg} h-full rounded-full transition-all" style="width: ${percent}%"></div></div><span class="w-12 text-sm text-right font-mono">${s.count}</span></div>`;
            }).join('') || '<p class="text-gray-500 text-center py-4">No data available</p>';
        }
        
        async function loadAlerts() {
            try {
                const params = new URLSearchParams({ page: state.currentPage, per_page: 50, ...state.filters });
                const res = await fetch(`/api/alerts?${params}`);
                const data = await res.json();
                state.alerts = data.alerts; state.totalPages = data.pages;
                renderAlertsTable(data.alerts);
                renderRecentAlerts(data.alerts.slice(0, 5));
                updatePagination(data);
            } catch (e) { console.error('Failed to load alerts:', e); }
        }
        
        async function loadArchivedAlerts() {
            try {
                const res = await fetch('/api/alerts?archived=1');
                const data = await res.json();
                renderArchivedTable(data.alerts);
            } catch (e) { console.error('Failed to load archived alerts:', e); }
        }
        
        function renderAlertsTable(alerts) {
            const tbody = document.getElementById('alerts-table-body');
            const empty = document.getElementById('alerts-empty');
            if (!alerts || !alerts.length) { tbody.innerHTML = ''; empty.classList.remove('hidden'); return; }
            empty.classList.add('hidden');
            const severityClasses = { 5: 'bg-zabbix-disaster', 4: 'bg-zabbix-high', 3: 'bg-zabbix-average', 2: 'bg-zabbix-warning', 1: 'bg-zabbix-info', 0: 'bg-zabbix-notclass' };
            tbody.innerHTML = alerts.map(alert => {
                const severity = alert.severity !== null && alert.severity !== undefined ? parseInt(alert.severity) : 0;
                const severityName = alert.severity_name || 'Unknown';
                const hostName = alert.host_name || 'Unknown';
                const triggerName = alert.trigger_name || 'Unknown';
                const status = alert.status !== null && alert.status !== undefined ? parseInt(alert.status) : 0;
                const isRead = alert.is_read ? true : false;
                const commentsCount = alert.comments_count || 0;
                const categoryName = alert.category_name || '';
                const categoryColor = alert.category_color || '#6b7280';
                const clock = alert.clock || '';
                
                return `
                <tr class="alert-row border-b border-dark-700 ${isRead ? '' : 'unread'}">
                    <td class="px-4 py-3"><input type="checkbox" data-id="${alert.id}" onchange="toggleAlertSelection(${alert.id})" class="alert-checkbox rounded bg-dark-600 border-dark-500" ${state.selectedAlerts.has(alert.id) ? 'checked' : ''}></td>
                    <td class="px-4 py-3"><span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium ${severityClasses[severity] || 'bg-gray-500'} text-white ${severity >= 4 ? 'severity-pulse' : ''}">${escapeHtml(severityName)}</span></td>
                    <td class="px-4 py-3"><span class="font-medium">${escapeHtml(hostName)}</span></td>
                    <td class="px-4 py-3"><div class="max-w-md truncate" title="${escapeHtml(triggerName)}">${escapeHtml(triggerName)}</div>${commentsCount > 0 ? `<span class="text-xs text-gray-500"><i class="bi bi-chat"></i> ${commentsCount}</span>` : ''}</td>
                    <td class="px-4 py-3">${categoryName ? `<span class="inline-flex items-center px-2 py-1 rounded-lg text-xs" style="background-color: ${categoryColor}20; color: ${categoryColor}">${escapeHtml(categoryName)}</span>` : '<span class="text-gray-500">â€”</span>'}</td>
                    <td class="px-4 py-3 text-sm text-gray-400 font-mono">${formatDate(clock)}</td>
                    <td class="px-4 py-3">${status === 0 ? '<span class="inline-flex items-center px-2 py-1 rounded-lg text-xs bg-red-500/20 text-red-400"><i class="bi bi-circle-fill text-[6px] mr-1.5"></i>Active</span>' : '<span class="inline-flex items-center px-2 py-1 rounded-lg text-xs bg-green-500/20 text-green-400"><i class="bi bi-check-circle-fill mr-1"></i>Resolved</span>'}</td>
                    <td class="px-4 py-3"><div class="flex items-center space-x-1"><button onclick="openAlertDetail(${alert.id})" class="p-2 hover:bg-dark-600 rounded-lg transition-colors" title="View Details"><i class="bi bi-eye"></i></button><button onclick="archiveAlert(${alert.id})" class="p-2 hover:bg-dark-600 rounded-lg transition-colors" title="Archive"><i class="bi bi-archive"></i></button></div></td>
                </tr>
            `}).join('');
        }
        
        function renderArchivedTable(alerts) {
            const tbody = document.getElementById('archived-table-body');
            const empty = document.getElementById('archived-empty');
            if (!alerts || !alerts.length) { tbody.innerHTML = ''; empty.classList.remove('hidden'); return; }
            empty.classList.add('hidden');
            const severityClasses = { 5: 'bg-zabbix-disaster', 4: 'bg-zabbix-high', 3: 'bg-zabbix-average', 2: 'bg-zabbix-warning', 1: 'bg-zabbix-info', 0: 'bg-zabbix-notclass' };
            tbody.innerHTML = alerts.map(alert => {
                const severity = alert.severity !== null && alert.severity !== undefined ? parseInt(alert.severity) : 0;
                const severityName = alert.severity_name || 'Unknown';
                const hostName = alert.host_name || 'Unknown';
                const triggerName = alert.trigger_name || 'Unknown';
                return `
                <tr class="alert-row border-b border-dark-700">
                    <td class="px-4 py-3"><input type="checkbox" data-id="${alert.id}" class="archived-checkbox rounded bg-dark-600 border-dark-500"></td>
                    <td class="px-4 py-3"><span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium ${severityClasses[severity] || 'bg-gray-500'} text-white opacity-75">${escapeHtml(severityName)}</span></td>
                    <td class="px-4 py-3 text-gray-400">${escapeHtml(hostName)}</td>
                    <td class="px-4 py-3 text-gray-400 max-w-md truncate">${escapeHtml(triggerName)}</td>
                    <td class="px-4 py-3 text-sm text-gray-500 font-mono">${formatDate(alert.updated_at)}</td>
                    <td class="px-4 py-3"><button onclick="unarchiveAlert(${alert.id})" class="p-2 hover:bg-dark-600 rounded-lg transition-colors" title="Unarchive"><i class="bi bi-arrow-counterclockwise"></i></button></td>
                </tr>
            `}).join('');
        }
        
        function renderRecentAlerts(alerts) {
            const container = document.getElementById('recent-alerts');
            if (!alerts || !alerts.length) { container.innerHTML = '<p class="text-gray-500 text-center py-4">No recent alerts</p>'; return; }
            container.innerHTML = alerts.map(alert => {
                const hostName = alert.host_name || 'Unknown';
                const triggerName = alert.trigger_name || 'Unknown';
                const severityColor = alert.severity_color || '#6b7280';
                return `
                <div class="flex items-center space-x-3 p-3 bg-dark-700 rounded-xl hover:bg-dark-600 transition-colors cursor-pointer" onclick="openAlertDetail(${alert.id})">
                    <div class="w-3 h-3 rounded-full" style="background-color: ${severityColor}"></div>
                    <div class="flex-1 min-w-0"><p class="text-sm font-medium truncate">${escapeHtml(hostName)}</p><p class="text-xs text-gray-500 truncate">${escapeHtml(triggerName)}</p></div>
                    <span class="text-xs text-gray-500">${formatTimeAgo(alert.clock)}</span>
                </div>
            `}).join('');
        }
        
        function updatePagination(data) {
            document.getElementById('pagination-info').textContent = `Showing ${data.alerts.length} of ${data.total} alerts`;
            document.getElementById('current-page').textContent = data.page;
            document.getElementById('prev-page').disabled = data.page <= 1;
            document.getElementById('next-page').disabled = data.page >= data.pages;
        }
        
        function changePage(delta) { state.currentPage = Math.max(1, Math.min(state.totalPages, state.currentPage + delta)); loadAlerts(); }
        
        function applyFilters() {
            state.filters = { search: document.getElementById('search-input').value, severity: document.getElementById('filter-severity').value, status: document.getElementById('filter-status').value, category_id: document.getElementById('filter-category').value };
            state.currentPage = 1; loadAlerts();
        }
        
        function clearFilters() {
            document.getElementById('search-input').value = ''; document.getElementById('filter-severity').value = '';
            document.getElementById('filter-status').value = ''; document.getElementById('filter-category').value = '';
            state.filters = { search: '', severity: '', status: '', category_id: '' }; state.currentPage = 1; loadAlerts();
        }
        
        function toggleAlertSelection(id) { if (state.selectedAlerts.has(id)) state.selectedAlerts.delete(id); else state.selectedAlerts.add(id); updateBulkActions(); }
        function toggleSelectAll() { const checkAll = document.getElementById('select-all').checked; document.querySelectorAll('.alert-checkbox').forEach(cb => { cb.checked = checkAll; if (checkAll) state.selectedAlerts.add(parseInt(cb.dataset.id)); else state.selectedAlerts.delete(parseInt(cb.dataset.id)); }); updateBulkActions(); }
        function updateBulkActions() { const bulkDiv = document.getElementById('bulk-actions'); const count = state.selectedAlerts.size; if (count > 0) { bulkDiv.classList.remove('hidden'); document.getElementById('selected-count').textContent = count; } else { bulkDiv.classList.add('hidden'); } }
        
        async function bulkAction(action) {
            if (!state.selectedAlerts.size) return;
            if (action === 'delete' && !confirm('Are you sure you want to delete the selected alerts?')) return;
            try {
                const res = await fetch('/api/bulk-action', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action, alert_ids: Array.from(state.selectedAlerts) }) });
                const data = await res.json();
                if (data.status === 'success') { showToast(data.message, 'success'); state.selectedAlerts.clear(); updateBulkActions(); await loadAlerts(); await loadStats(); }
            } catch (e) { showToast('Bulk action failed', 'error'); }
        }
        
        async function archiveAlert(id) { try { await fetch(`/api/alerts/${id}`, { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ is_archived: true }) }); showToast('Alert archived', 'success'); await loadAlerts(); await loadStats(); } catch (e) { showToast('Failed to archive alert', 'error'); } }
        async function unarchiveAlert(id) { try { await fetch(`/api/alerts/${id}`, { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ is_archived: false }) }); showToast('Alert restored', 'success'); await loadArchivedAlerts(); await loadStats(); } catch (e) { showToast('Failed to restore alert', 'error'); } }
        
        async function openAlertDetail(id) {
            try {
                const res = await fetch(`/api/alerts/${id}`);
                const alert = await res.json();
                if (!alert.is_read) { await fetch(`/api/alerts/${id}`, { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ is_read: true }) }); loadStats(); loadAlerts(); }
                const severityColors = { 5: '#E45959', 4: '#E97659', 3: '#FFA059', 2: '#FFC859', 1: '#7499FF', 0: '#97AAB3' };
                document.getElementById('alert-detail-content').innerHTML = `
                    <div class="space-y-6">
                        <div class="flex items-start justify-between"><div><span class="inline-block px-3 py-1 rounded-full text-sm font-medium text-white mb-2" style="background-color: ${severityColors[alert.severity]}">${alert.severity_name}</span><h4 class="text-xl font-bold">${escapeHtml(alert.host_name)}</h4></div>${alert.status === 0 ? '<span class="px-3 py-1 bg-red-500/20 text-red-400 rounded-lg text-sm">Active</span>' : '<span class="px-3 py-1 bg-green-500/20 text-green-400 rounded-lg text-sm">Resolved</span>'}</div>
                        <div class="bg-dark-700 rounded-xl p-4"><h5 class="text-sm font-medium text-gray-400 mb-2">Problem</h5><p class="text-white">${escapeHtml(alert.trigger_name)}</p></div>
                        <div class="grid grid-cols-2 gap-4"><div class="bg-dark-700 rounded-xl p-4"><h5 class="text-sm font-medium text-gray-400 mb-1">Event ID</h5><p class="font-mono text-sm">${alert.event_id}</p></div><div class="bg-dark-700 rounded-xl p-4"><h5 class="text-sm font-medium text-gray-400 mb-1">Created</h5><p class="font-mono text-sm">${formatDate(alert.clock)}</p></div></div>
                        <div><h5 class="text-sm font-medium text-gray-400 mb-2">Category</h5><select id="alert-category-select" onchange="updateAlertCategory(${alert.id}, this.value)" class="w-full px-4 py-3 bg-dark-700 border border-dark-600 rounded-lg text-white focus:outline-none focus:border-indigo-500"><option value="">No Category</option>${state.categories.map(c => `<option value="${c.id}" ${alert.category_id === c.id ? 'selected' : ''}>${c.name}</option>`).join('')}</select></div>
                        <div><h5 class="text-sm font-medium text-gray-400 mb-2">Comments</h5><div id="alert-comments" class="space-y-3 mb-4 max-h-60 overflow-y-auto">${alert.comments && alert.comments.length ? alert.comments.map(c => `<div class="bg-dark-700 rounded-xl p-3"><div class="flex justify-between items-center mb-1"><span class="text-sm font-medium">${escapeHtml(c.author)}</span><span class="text-xs text-gray-500">${formatTimeAgo(c.created_at)}</span></div><p class="text-sm text-gray-300">${escapeHtml(c.comment)}</p></div>`).join('') : '<p class="text-gray-500 text-sm">No comments yet</p>'}</div><div class="flex space-x-2"><input type="text" id="new-comment-input" placeholder="Add a comment..." class="flex-1 px-4 py-2 bg-dark-700 border border-dark-600 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-indigo-500"><button onclick="addComment(${alert.id})" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 rounded-lg transition-colors"><i class="bi bi-send"></i></button></div></div>
                        <div class="flex space-x-3 pt-4 border-t border-dark-600"><button onclick="archiveAlert(${alert.id}); closeAlertModal();" class="flex-1 px-4 py-2 bg-dark-700 hover:bg-dark-600 rounded-lg transition-colors"><i class="bi bi-archive mr-2"></i>Archive</button><button onclick="deleteAlert(${alert.id})" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg transition-colors"><i class="bi bi-trash"></i></button></div>
                    </div>
                `;
                document.getElementById('alert-modal').classList.remove('hidden');
            } catch (e) { showToast('Failed to load alert details', 'error'); }
        }
        
        function closeAlertModal() { document.getElementById('alert-modal').classList.add('hidden'); }
        
        async function updateAlertCategory(alertId, categoryId) { try { await fetch(`/api/alerts/${alertId}`, { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ category_id: categoryId || null }) }); showToast('Category updated', 'success'); loadAlerts(); } catch (e) { showToast('Failed to update category', 'error'); } }
        
        async function addComment(alertId) {
            const input = document.getElementById('new-comment-input');
            const comment = input.value.trim();
            if (!comment) return;
            try { await fetch(`/api/alerts/${alertId}/comments`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ comment, author: 'User' }) }); input.value = ''; showToast('Comment added', 'success'); openAlertDetail(alertId); } catch (e) { showToast('Failed to add comment', 'error'); }
        }
        
        async function deleteAlert(id) { if (!confirm('Are you sure you want to delete this alert?')) return; try { await fetch(`/api/alerts/${id}`, { method: 'DELETE' }); showToast('Alert deleted', 'success'); closeAlertModal(); loadAlerts(); loadStats(); } catch (e) { showToast('Failed to delete alert', 'error'); } }
        
        async function loadCategories() {
            try {
                const res = await fetch('/api/categories');
                state.categories = await res.json();
                const select = document.getElementById('filter-category');
                select.innerHTML = '<option value="">All Categories</option>' + state.categories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
                renderCategories();
            } catch (e) { console.error('Failed to load categories:', e); }
        }
        
        function renderCategories() {
            const grid = document.getElementById('categories-grid');
            grid.innerHTML = state.categories.map(cat => `
                <div class="bg-dark-800 rounded-2xl p-6 border border-dark-600 card-hover">
                    <div class="flex items-center justify-between mb-4"><div class="w-12 h-12 rounded-xl flex items-center justify-center" style="background-color: ${cat.color}20"><i class="bi bi-${cat.icon || 'folder'} text-xl" style="color: ${cat.color}"></i></div><div class="flex space-x-1"><button onclick="editCategory(${cat.id})" class="p-2 hover:bg-dark-600 rounded-lg transition-colors"><i class="bi bi-pencil text-gray-400"></i></button><button onclick="deleteCategory(${cat.id})" class="p-2 hover:bg-dark-600 rounded-lg transition-colors"><i class="bi bi-trash text-gray-400"></i></button></div></div>
                    <h4 class="font-semibold text-lg mb-1">${escapeHtml(cat.name)}</h4><p class="text-sm text-gray-500 mb-3">${escapeHtml(cat.description || 'No description')}</p>
                    <div class="flex items-center justify-between"><span class="text-2xl font-bold" style="color: ${cat.color}">${cat.alert_count || 0}</span><span class="text-xs text-gray-500">alerts</span></div>
                </div>
            `).join('');
        }
        
        function openCategoryModal(editId = null) {
            document.getElementById('category-modal-title').textContent = editId ? 'Edit Category' : 'New Category';
            document.getElementById('category-edit-id').value = editId || '';
            if (editId) {
                const cat = state.categories.find(c => c.id === editId);
                if (cat) { document.getElementById('category-name').value = cat.name; document.getElementById('category-color').value = cat.color; document.getElementById('category-color-text').value = cat.color; document.getElementById('category-description').value = cat.description || ''; }
            } else { document.getElementById('category-name').value = ''; document.getElementById('category-color').value = '#6366f1'; document.getElementById('category-color-text').value = '#6366f1'; document.getElementById('category-description').value = ''; }
            document.getElementById('category-modal').classList.remove('hidden');
        }
        
        function closeCategoryModal() { document.getElementById('category-modal').classList.add('hidden'); }
        
        async function saveCategory() {
            const editId = document.getElementById('category-edit-id').value;
            const data = { name: document.getElementById('category-name').value, color: document.getElementById('category-color').value, description: document.getElementById('category-description').value };
            try {
                const url = editId ? `/api/categories/${editId}` : '/api/categories';
                const method = editId ? 'PATCH' : 'POST';
                const res = await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
                const result = await res.json();
                if (result.status === 'success') { showToast(editId ? 'Category updated' : 'Category created', 'success'); closeCategoryModal(); loadCategories(); }
                else { showToast(result.message || 'Failed to save category', 'error'); }
            } catch (e) { showToast('Failed to save category', 'error'); }
        }
        
        function editCategory(id) { openCategoryModal(id); }
        async function deleteCategory(id) { if (!confirm('Are you sure? Alerts in this category will become uncategorized.')) return; try { await fetch(`/api/categories/${id}`, { method: 'DELETE' }); showToast('Category deleted', 'success'); loadCategories(); } catch (e) { showToast('Failed to delete category', 'error'); } }
        
        function openBulkCategoryModal() { const catSelect = state.categories.map(c => `${c.id}: ${c.name}`).join('\n'); const catId = prompt(`Enter category ID:\n${catSelect}`); if (catId) bulkSetCategory(parseInt(catId)); }
        async function bulkSetCategory(categoryId) { try { await fetch('/api/bulk-action', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: 'set_category', category_id: categoryId, alert_ids: Array.from(state.selectedAlerts) }) }); showToast('Category set for selected alerts', 'success'); state.selectedAlerts.clear(); updateBulkActions(); loadAlerts(); } catch (e) { showToast('Failed to set category', 'error'); } }
        
        // Analytics Functions
        async function loadAnalytics() {
            try {
                const res = await fetch('/api/analytics');
                const data = await res.json();
                if (data.error) { showToast('Failed to load analytics: ' + data.error, 'error'); return; }
                renderAnalytics(data);
            } catch (e) { console.error('Failed to load analytics:', e); showToast('Failed to load analytics', 'error'); }
        }
        
        function renderAnalytics(data) {
            document.getElementById('analytics-total-hosts').textContent = data.host_health?.total_hosts || 0;
            document.getElementById('analytics-critical-hosts').textContent = data.host_health?.critical_hosts || 0;
            document.getElementById('analytics-uncategorized').textContent = data.uncategorized_count || 0;
            const mttr = data.mttr_minutes || 0;
            let mttrText = '0m';
            if (mttr >= 60) { mttrText = `${Math.floor(mttr / 60)}h ${Math.round(mttr % 60)}m`; } 
            else if (mttr > 0) { mttrText = `${Math.round(mttr)}m`; }
            document.getElementById('analytics-mttr').textContent = mttrText;
            renderTopHosts(data.top_hosts || []);
            renderAlertTypes(data.alert_types || []);
            renderSeverityChartAnalytics(data.severity_distribution || []);
            renderHostHealth(data.host_health || {});
            renderHourlyChart(data.hourly_distribution || []);
            renderDailyTrend(data.daily_trend || []);
            renderRepeatOffenders(data.repeat_offenders || []);
            renderCategoryBreakdown(data.category_breakdown || [], data.uncategorized_count || 0);
        }
        
        function renderTopHosts(hosts) {
            const container = document.getElementById('top-hosts-list');
            if (!hosts.length) { container.innerHTML = '<div class="p-8 text-center text-gray-500">No host data available</div>'; return; }
            const maxAlerts = Math.max(...hosts.map(h => h.total_alerts));
            const severityColors = { 5: 'bg-red-500', 4: 'bg-orange-500', 3: 'bg-amber-500', 2: 'bg-yellow-500', 1: 'bg-blue-500', 0: 'bg-gray-500' };
            container.innerHTML = hosts.map((host, idx) => {
                const percent = (host.total_alerts / maxAlerts) * 100;
                const sevClass = severityColors[host.max_severity] || 'bg-gray-500';
                return `<div class="p-3 hover:bg-dark-700 cursor-pointer border-b border-dark-700 transition-colors" onclick="filterByHost('${escapeHtml(host.host_name).replace(/'/g, "\\'")}')">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center space-x-2">
                            <span class="text-xs text-gray-500 w-6">#${idx + 1}</span>
                            <span class="w-2 h-2 rounded-full ${sevClass}"></span>
                            <span class="font-medium text-sm truncate max-w-48">${escapeHtml(host.host_name)}</span>
                        </div>
                        <div class="flex items-center space-x-3 text-xs">
                            <span class="text-red-400">${host.active_alerts} active</span>
                            <span class="text-gray-400">${host.total_alerts} total</span>
                        </div>
                    </div>
                    <div class="h-1.5 bg-dark-600 rounded-full overflow-hidden"><div class="h-full ${sevClass} rounded-full" style="width: ${percent}%"></div></div>
                </div>`;
            }).join('');
        }
        
        function renderAlertTypes(types) {
            const container = document.getElementById('alert-types-list');
            if (!types.length) { container.innerHTML = '<div class="p-8 text-center text-gray-500">No alert type data available</div>'; return; }
            const maxCount = Math.max(...types.map(t => t.count));
            const severityColors = { 5: 'bg-red-500', 4: 'bg-orange-500', 3: 'bg-amber-500', 2: 'bg-yellow-500', 1: 'bg-blue-500', 0: 'bg-gray-500' };
            container.innerHTML = types.map(type => {
                const percent = (type.count / maxCount) * 100;
                const sevClass = severityColors[Math.round(type.avg_severity)] || 'bg-gray-500';
                return `<div class="p-3 hover:bg-dark-700 border-b border-dark-700 transition-colors">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm truncate max-w-64" title="${escapeHtml(type.trigger_name)}">${escapeHtml(type.trigger_name)}</span>
                        <div class="flex items-center space-x-2 text-xs">
                            ${type.active > 0 ? `<span class="text-red-400">${type.active} active</span>` : ''}
                            <span class="text-gray-400">${type.count}x</span>
                        </div>
                    </div>
                    <div class="h-1.5 bg-dark-600 rounded-full overflow-hidden"><div class="h-full ${sevClass} rounded-full" style="width: ${percent}%"></div></div>
                </div>`;
            }).join('');
        }
        
        function renderSeverityChartAnalytics(distribution) {
            const container = document.getElementById('severity-chart');
            if (!distribution.length) { container.innerHTML = '<p class="text-gray-500 text-center">No data</p>'; return; }
            const total = distribution.reduce((sum, d) => sum + d.count, 0);
            container.innerHTML = distribution.map(d => {
                const percent = total > 0 ? Math.round((d.count / total) * 100) : 0;
                return `<div class="flex items-center space-x-3">
                    <div class="w-3 h-3 rounded-full" style="background-color: ${d.color}"></div>
                    <span class="text-sm flex-1">${d.severity_name}</span>
                    <span class="text-sm font-mono">${d.count}</span>
                    <span class="text-xs text-gray-500 w-10 text-right">${percent}%</span>
                </div>`;
            }).join('');
        }
        
        function renderHostHealth(health) {
            const container = document.getElementById('host-health-chart');
            const total = health.total_hosts || 1;
            const items = [
                { label: 'Critical', count: health.critical_hosts || 0, color: 'bg-red-500' },
                { label: 'Warning', count: health.warning_hosts || 0, color: 'bg-yellow-500' },
                { label: 'Info', count: health.info_hosts || 0, color: 'bg-blue-500' },
                { label: 'Healthy', count: health.healthy_hosts || 0, color: 'bg-green-500' }
            ];
            container.innerHTML = items.map(item => {
                const percent = Math.round((item.count / total) * 100);
                return `<div><div class="flex justify-between text-sm mb-1"><span>${item.label}</span><span class="text-gray-400">${item.count} hosts</span></div>
                    <div class="h-2 bg-dark-600 rounded-full overflow-hidden"><div class="${item.color} h-full rounded-full" style="width: ${percent}%"></div></div></div>`;
            }).join('');
        }
        
        function renderHourlyChart(hourly) {
            const container = document.getElementById('hourly-chart');
            if (!hourly.length) { container.innerHTML = '<p class="text-gray-500 text-center w-full">No data</p>'; return; }
            const maxCount = Math.max(...hourly.map(h => h.count), 1);
            container.innerHTML = hourly.map(h => {
                const height = Math.max((h.count / maxCount) * 100, 2);
                const hour = parseInt(h.hour);
                const color = hour >= 9 && hour <= 17 ? 'bg-indigo-500' : 'bg-indigo-800';
                return `<div class="flex-1 flex flex-col items-center justify-end group" title="${h.hour}:00 - ${h.count} alerts">
                    <span class="text-xs text-gray-500 mb-1 opacity-0 group-hover:opacity-100">${h.count}</span>
                    <div class="${color} rounded-t w-full hover:bg-indigo-400" style="height: ${height}%"></div>
                </div>`;
            }).join('');
        }
        
        function renderDailyTrend(daily) {
            const container = document.getElementById('daily-trend-chart');
            if (!daily.length) { container.innerHTML = '<p class="text-gray-500 text-center w-full">No data</p>'; return; }
            const maxCount = Math.max(...daily.map(d => d.count), 1);
            container.innerHTML = daily.map(d => {
                const height = Math.max((d.count / maxCount) * 100, 2);
                const activePercent = d.count > 0 ? (d.active / d.count) * 100 : 0;
                return `<div class="flex-1 flex flex-col items-center justify-end group" title="${d.day}: ${d.count} alerts (${d.active} active)">
                    <span class="text-xs text-gray-500 mb-1 opacity-0 group-hover:opacity-100">${d.count}</span>
                    <div class="w-full rounded-t bg-green-500 relative" style="height: ${height}%">
                        <div class="absolute bottom-0 left-0 right-0 bg-red-500 rounded-t" style="height: ${activePercent}%"></div>
                    </div>
                </div>`;
            }).join('');
        }
        
        function renderRepeatOffenders(offenders) {
            const container = document.getElementById('repeat-offenders-list');
            if (!offenders.length) { container.innerHTML = '<div class="p-8 text-center text-gray-500"><i class="bi bi-emoji-smile text-2xl mb-2"></i><p>No recurring issues found!</p></div>'; return; }
            container.innerHTML = offenders.map(o => `<div class="p-3 hover:bg-dark-700 border-b border-dark-700 cursor-pointer" onclick="filterByHost('${escapeHtml(o.host_name).replace(/'/g, "\\'")}')">
                <div class="flex items-center justify-between mb-1">
                    <span class="font-medium text-sm">${escapeHtml(o.host_name)}</span>
                    <span class="text-orange-400 text-xs font-bold">${o.occurrences}x</span>
                </div>
                <p class="text-xs text-gray-400 truncate">${escapeHtml(o.trigger_name)}</p>
            </div>`).join('');
        }
        
        function renderCategoryBreakdown(categories, uncategorized) {
            const container = document.getElementById('category-breakdown');
            let html = categories.map(c => `<div class="bg-dark-700 rounded-xl p-4 text-center hover:bg-dark-600 cursor-pointer">
                <div class="w-10 h-10 rounded-lg mx-auto mb-2 flex items-center justify-center" style="background-color: ${c.color}20">
                    <i class="bi bi-folder text-lg" style="color: ${c.color}"></i>
                </div>
                <p class="font-medium text-sm truncate">${escapeHtml(c.name)}</p>
                <p class="text-2xl font-bold mt-1" style="color: ${c.color}">${c.count}</p>
                <p class="text-xs text-gray-500">${c.active} active</p>
            </div>`).join('');
            html += `<div class="bg-dark-700 rounded-xl p-4 text-center hover:bg-dark-600 cursor-pointer">
                <div class="w-10 h-10 rounded-lg mx-auto mb-2 flex items-center justify-center bg-gray-500/20">
                    <i class="bi bi-question-circle text-lg text-gray-400"></i>
                </div>
                <p class="font-medium text-sm">Uncategorized</p>
                <p class="text-2xl font-bold mt-1 text-gray-400">${uncategorized}</p>
                <p class="text-xs text-gray-500">needs review</p>
            </div>`;
            container.innerHTML = html;
        }
        
        function filterByHost(hostName) {
            showSection('alerts');
            document.getElementById('search-input').value = hostName;
            state.filters.search = hostName;
            state.currentPage = 1;
            loadAlerts();
            showToast(`Filtered by host: ${hostName}`, 'info');
        }
        
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const id = Date.now();
            const colors = { success: 'bg-green-600', error: 'bg-red-600', info: 'bg-indigo-600', warning: 'bg-yellow-600' };
            const icons = { success: 'bi-check-circle-fill', error: 'bi-x-circle-fill', info: 'bi-info-circle-fill', warning: 'bi-exclamation-triangle-fill' };
            const toast = document.createElement('div');
            toast.id = `toast-${id}`;
            toast.className = `toast flex items-center space-x-3 px-4 py-3 rounded-xl shadow-lg ${colors[type]}`;
            toast.innerHTML = `<i class="bi ${icons[type]}"></i><span>${escapeHtml(message)}</span>`;
            container.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 300); }, 3000);
        }
        
        function escapeHtml(str) { if (!str) return ''; const div = document.createElement('div'); div.textContent = str; return div.innerHTML; }
        function formatDate(dateStr) { if (!dateStr) return 'â€”'; return new Date(dateStr).toLocaleString(); }
        function formatTimeAgo(dateStr) { if (!dateStr) return ''; const diff = Math.floor((new Date() - new Date(dateStr)) / 1000); if (diff < 60) return 'Just now'; if (diff < 3600) return `${Math.floor(diff / 60)}m ago`; if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`; if (diff < 604800) return `${Math.floor(diff / 86400)}d ago`; return formatDate(dateStr); }
    </script>
</body>
</html>